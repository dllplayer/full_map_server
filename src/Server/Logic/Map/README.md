# 无缝大地图设计

### 从单进程说起

在mmo的地图逻辑中,玩家需要与当前场景的对象进行交互,比如 NPC ,怪物,场景物品,且这些对象往往是对全地图的玩家开放,也就意味着,一个对象的状态发生改变时,也需要对全地图的玩家进行广播,才能让发起主动交互玩家外的玩家获取被交互对象的最新的正确状态,基于此来实现各种效果,如 怪物死亡,NPC移动,场景物品的掉落拾取,技能释放等逻辑.

那么在上述需求的前提下,我们要怎么进行同步呢?

显而易见的最简单方法是,当一个对象发生变化时,可以遍历当前地图的所有玩家对他们进行消息同步来实现我们的目的,但是更显而易见的可以让我们想象到这个方案的弊处,如果一个地图大小为1000X1000,玩家屏幕大小为10X10

那么当玩家处于地图左上角时,右下角其他玩家的对象操作,其实我们是不关心的,我们在进行游戏行为时更关心的是我们当前屏幕能看到的对象,且一个地图如果有100个玩家,每个玩家1秒钟都要进行一次行为,那么一秒钟的消息数量即为 100 * 100 达到1万条,这也显然是我们不可接受的.所以有了AOI的说法.

AOI 即 arena of interests ,感兴趣的区域,其实现方案不在本文的讨论范围内,主要有 灯塔,九宫格,十字链表 法三种,各有优劣,但说到底,这些都是手段,我们还是要探究为什么能解决上一段提出的优化,简单的了解思路后即使不进行实现,我们也可以知晓其原理,其会将地图进行分割,并只找出自己感兴趣的区域,在一个对象发生变化后,也只同步给周围的对象,虽然从复杂度来说也算是 n^2,但是由于同步的玩家变少了,从原来的 100*100 缩减成 10\*10 * N,有一个数量级的优化,也就提高的逻辑的效率.

不过即使有各种优化,包括多线程级优化,却永远无法突破物理机的限制,即使单进程实现了1000张地图逻辑,那他也会在第1001张地图的时候表现出瓶颈,因为无论是多么高的配置,单机的承载能力是有上限的.在此限制前提下,也就是意味着使用单进程来实现无缝地图的服务器的逻辑是不可行的.

那如何完成我们的无缝大地图的服务器框架,我曾在一段时间内反复思考这个问题,有想出一些方案似乎能解决,但没有时间去实现,且也想更深入的思考,直到最近看了kbengine 的设计思路后,才发现自己的方案已经有人实践并证明了其可行性.

核心点就2个,一个是分布式AOI,另一个是主从数据

由于单进程的物理限制,一个可以无限扩展的无缝大地图一定会发生两张相邻的地图可能被部署在两台物理机上的情况,也就以为着当玩家在两张地图边缘时,要怎么处理其行为,以及如何让边缘的玩家知道他的动作.

在此条件下,单进程AOI 肯定是不能做到的,

## 分布式AOI

## GHOST 

 

